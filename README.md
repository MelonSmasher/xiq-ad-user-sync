# Extreme XIQ AD User Sync

Python script to sync users from Active Directory to Extreme XIQ as PPSK users.

## Features

- Sync user state from Active Directory group to Extreme XIQ
- Generate Wi-Fi passwords for PPSK users
  - Optional word based passphrases with configurable word count
  - Letters, special characters, and numbers in password obey configured XIQ password policy
  - Optionaly check password against Have I Been Pwned API to ensure password is not compromised
- Generate Wi-Fi connection QR codes for users
- Send email to users with Wi-Fi connection information optionally include Wi-Fi connection QR code
- Post Wi-Fi connection information and QR Code to a webhook
  - See [QR Code Server](https://github.com/MelonSmasher/qr-code-server) for ability to share Wi-Fi connection information via web based kiosk/signage

## Requirements

- Python 3.8+
- Active Directory
- Extreme XIQ

### Extreme API Docs

- [ExtremeCloud XIQ API](https://api.extremecloudiq.com/swagger-ui/index.html#/)

## Installation

Clone the repository

```bash
git clone https://github.com/MelonSmasher/xiq-ad-user-sync.git && cd xiq-ad-user-sync
```

Create a virtual environment

```bash
python3 -m venv venv
```

Install the required packages

```bash
source venv/bin/activate && pip install -r requirements.txt
```

## Configuration

Create a `.env` file in the root of the project.

```bash
cp support/example.env .env
```

### Environment Variables

Fill in the `.env` file with variables from the table below.

| Variable                          | Required           | Type                                                                                                           | Default Value                  | Valid Values                                                                                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
|-----------------------------------|--------------------|----------------------------------------------------------------------------------------------------------------|--------------------------------|---------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| LOG_LEVEL                         |                    | enum(string('DEBUG'), string('INFO'), string('WARNING'), string('ERROR'))                                      | 'INFO'                         | 'DEBUG', 'INFO', 'WARNING', 'ERROR'                                                         | The log level for the application.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| LOG_TO_FILE                       |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | Log to file in addition to stdout.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| LDAP_HOSTS                        | :white_check_mark: | comma_separated values_string(colon_separated values_string)                                                   |                                | see description                                                                             | Comma separated list of LDAP hosts, each host item is colon separated with the hostname, port, and if SSL is enabled. Example: `ldap.example.com:389:False,ldap2.example.com:636:True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| LDAP_DOMAIN                       | :white_check_mark: | string                                                                                                         |                                | any                                                                                         | The domain to use for the LDAP connection. Example: `example.com`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| LDAP_USERNAME                     | :white_check_mark: | string                                                                                                         |                                | any                                                                                         | The username to use for the LDAP connection. Example: `svc_ad_sync_user`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| LDAP_PASSWORD                     | :white_check_mark: | string                                                                                                         |                                | any                                                                                         | The password to use for the LDAP connection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| LDAP_AUTH_METHOD                  |                    | enum(string('NTLM'), string('ANONYMOUS'), string('SIMPLE'), string('SASL'))                                    | 'NTLM'                         | 'NTLM', 'ANONYMOUS', 'SIMPLE', 'SASL'                                                       | https://ldap3.readthedocs.io/en/latest/connection.html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| LDAP_SASL_MECHANISM               |                    | enum(string('GSSAPI'), string('EXTERNAL'), string('DIGEST-MD5'), string('PLAIN'))                              | 'GSSAPI'                       | 'EXTERNAL', 'DIGEST-MD5', 'GSSAPI', 'PLAIN'                                                 | https://ldap3.readthedocs.io/en/latest/connection.html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| LDAP_AUTO_BIND                    |                    | enum(string('NO_TLS'), string('DEFAULT'), string('NONE'), string('TLS_BEFORE_BIND'), string('TLS_AFTER_BIND')) | 'NO_TLS'                       | 'DEFAULT', 'NONE', 'NO_TLS', 'TLS_BEFORE_BIND', 'TLS_AFTER_BIND'                            | https://ldap3.readthedocs.io/en/latest/connection.html                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| LDAP_DISABLE_CODES                |                    | comma_separated values_string(int)                                                                             | '514', '642', '66050', '66178' | CSV string of LDAP disable codes                                                            | A comma separated list as a string containing integer values that represent valid codes that designate a user as disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| XIQ_URL                           |                    | string                                                                                                         | https://api.extremecloudiq.com | any                                                                                         | Base URL for the XIQ client to connect to when making XIQ API requests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| XIQ_USERNAME                      | :white_check_mark: | string                                                                                                         |                                | any                                                                                         | Username to authenticate with the XIQ API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| XIQ_PASSWORD                      | :white_check_mark: | string                                                                                                         |                                | any                                                                                         | Password to authenticate with the XIQ API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| XIQ_VERIFY_SSL                    |                    | bool(string('True'), string('False'))                                                                          | 'True'                         | 'True', 'False'                                                                             | Controls if SSL verification is enabled when communicating to the XIQ API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| XIQ_PCG_ENABLED                   |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | Controls if XIQ PCG is enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| XIQ_CHECK_PASSWORD_AGAINST_PWNED  |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | If enabled, a hashed version of the generated password will be compaired against known leaked passwords as hashes and if the password is leaked a new one will be generated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| XIQ_STRICT_PASSWORD_CHECK         |                    | bool(string('True'), string('False'))                                                                          | 'True'                         | 'True', 'False'                                                                             | If a password is leaked and strict checking is enabled a new password will be generated, if diabled a warning will be logged and the password will still be used. Has no effect if XIQ_CHECK_PASSWORD_AGAINST_PWNED is disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| XIQ_PASSWORD_GENERATOR_USE_WORDS  |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | If enabled and the XIQ policy has letters enabled, the password will use english words instead of random letters. If numbers and special chars are enabled in the XIQ policy the words will be separated by those chars.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| XIQ_PASSWORD_GENERATOR_WORD_COUNT |                    | int                                                                                                            | 4                              | any positive integer                                                                        | If XIQ_PASSWORD_GENERATOR_USE_WORDS is enabled, this setting controls how many words will be in the password. Otherwise this setting has no effect.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| XIQ_MAIL_FOR_SSIDS                |                    | comma_separated values_string(string)                                                                          |                                | CSV string of broadcast SSIDs that trigger an email for a newly created user                | If enabled this controls which SSIDs will trigger emails to endusers. This helps avoid a flood of emails for eronious SSIDs found in the same policy. If empty no emails will be sent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| MAPPING_AD_GROUP_TO_XIQ_ROLE      | :white_check_mark: | pipe_separated_values_string(colon_separated values_string)                                                    |                                | see description                                                                             | Pipe delimited list of AD groups as DNs to XIQ roles. Format: AD_GROUP_DN:ROLE_ID&#124;AD_GROUP_DN:ROLE_ID&#124;...                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| MAPPING_PCG                       | :white_check_mark: | comma_separated_values_string(colon_separated values_string)                                                   |                                | see description                                                                             | Comma delimited list of XIQ_Role_Id:UserGroupNames:network_policy_id:policy_name,XIQ_Role_Id:UserGroupNames:network_policy_id:policy_name,...                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| QR_CODE_ENABLED                   |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | Controls if a QR code is generated with Wi-Fi connection information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| QR_CODE_LOGO_PATH                 |                    | string                                                                                                         |                                | file system path or HTTP/HTTPS remote path or base64 encoded image data                     | Used to place a logo within the QR code. Can be a local path to an image, a remote HTTP URL to an image, or a base64 encoded string witch contains image data. Base64 encoded data should start with `data:image/jpg;base64,` to signify that it's a base64 blob, the image format should be changed from jpg to match the image type, for example `data:image/png;base64,` would be used for PNG data. To extract base64 data from an image file the follow has been tested on macOS `IMAGE_PATH=/path/to/image.jpg; IMAGE_EXT="$(basename ${IMAGE_PATH} &#124; cut -d'.' -f2)"; B64=$(openssl base64 < "${IMAGE_PATH}" &#124; tr -d '\n'); echo "data:image/${IMAGE_EXT};base64,${B64}" &#124; pbcopy` |
| MAILGUN_API_KEY                   |                    | string                                                                                                         |                                | any                                                                                         | Your Mailgun API key                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| MAILGUN_DOMAIN                    |                    | string                                                                                                         |                                | any                                                                                         | Your Mailgun domain                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| MAILGUN_FROM                      |                    | string                                                                                                         |                                | any                                                                                         | The from address to send email from. Example: `My Company Name <no-reply@example.com>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| MAIL_ENABLED                      |                    | bool(string('True'), string('False'))                                                                          | 'False'                        | 'True', 'False'                                                                             | Controls if sending email through Mailgun is enabled or disabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| MAIL_LOGO                         |                    | string                                                                                                         |                                | file system path or HTTP/HTTPS remote path or base64 encoded image data                     | Logo to include at the top of emails. Can be a local path to an image, a remote HTTP URL to an image, or a base64 encoded string witch contains image data. Base64 encoded data should start with `data:image/jpg;base64,` to signify that it's a base64 blob, the image format should be changed from jpg to match the image type, for example `data:image/png;base64,` would be used for PNG data. To extract base64 data from an image file the follow has been tested on macOS `IMAGE_PATH=/path/to/image.jpg; IMAGE_EXT="$(basename ${IMAGE_PATH} &#124; cut -d'.' -f2)"; B64=$(openssl base64 < "${IMAGE_PATH}" &#124; tr -d '\n'); echo "data:image/${IMAGE_EXT};base64,${B64}" &#124; pbcopy`    |
| MAIL_COMPANY_NAME                 |                    | string                                                                                                         |                                | any                                                                                         | The name of your organization to include in the email template.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| MAIL_EXTRA_MESSAGE                |                    | string                                                                                                         |                                | any                                                                                         | Extra instructions/message/info to include in the email message to end users.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| MAIL_KB_ARTICLE_URL               |                    | string                                                                                                         |                                | any                                                                                         | URL to a web page that will help the user connect to Wi-Fi.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| MAIL_SUPPORT_EMAIL                |                    | string                                                                                                         |                                | any                                                                                         | An email address for users to reply to with question and for support.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| MAIL_SUPPORT_PAGE_URL             |                    | string                                                                                                         |                                | any                                                                                         | URL to a web page such as a helpdesk support portal where users can recieve support.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| WEBOOK_MAPPING                    |                    | comma_separated values_string(pipe_separated_values_string(string))                                            |                                | associated email address, SSID, qr code share server webhook                                | A mapping of email to SSID to qr code share server webhook separated by a pipe. Multiple mappings can be provided by separating them with a comma. Controls for which user and SSID combo an webhook is hit with wireless network information                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| BUILD_NOTIFICATION_EMAIL_TO       | :white_check_mark: | string                                                                                                         |                                | CSV string of valid emails to send notifications to.                                        | Email address(') to send build notifications to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| BUILD_NOTIFICATION_EMAIL_FROM     | :white_check_mark: | string                                                                                                         |                                | Email address in the following format: '"Jenkins Build Notifications" <jenkins@example.com> | Email address to send build notifications from.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |

## Usage

Run the script

```bash
source venv/bin/activate && python XIQ-AD-PPSK-Sync.py
```
